{% extends "base.twig" %}

{% block main %}
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

    <h1 class="title" id="contactFormTitle">
        {{ is_edit ? "Modifier l'article" : "Rédiger un article" }}
    </h1>

    <style>
        #articleFormContainer { max-width: 900px !important; }
        .editor-toolbar { background-color: #fff; color: #000; }
        [data-bs-theme="dark"] .CodeMirror, 
        [data-bs-theme="dark"] .editor-toolbar, 
        [data-bs-theme="dark"] .editor-preview-side {
            background-color: #2b3035; color: #ddd; border-color: #444;
        }
        [data-bs-theme="dark"] .editor-toolbar button { color: #ddd; }
        [data-bs-theme="dark"] .editor-toolbar button:hover { background-color: #444; }
    </style>

    <form action="{{ is_edit ? '/traitementEdition' : '/traitementCreation' }}" 
          method="POST" id="contactForm" class="mx-auto" style="max-width: 800px;" 
          enctype="multipart/form-data">
        
        {% if error %} <div class="alert alert-danger">{{ error }}</div> {% endif %}

        {% if is_edit %}
            <input type="hidden" name="article_id" value="{{ article_id }}">
        {% endif %}

        <label for="titre">Titre :</label>
        <input type="text" id="titre" name="titre" value="{{ data.titre }}" required>

        <label for="image">Image à la une :</label>
        <input type="file" name="image" id="image" class="form-control mb-3" accept="image/*" 
               style="background-color: var(--bg2); color: var(--font-color); border: 1px solid #ccc;">
        
        {% if data.image_une %}
            <div class="mb-3 text-center">
                <p>Image actuelle :</p>
                <img src="/uploads/{{ data.image_une }}" alt="Image actuelle" style="max-height: 150px; border-radius: 5px;">
                {# Champ caché pour conserver l'image si on n'en renvoie pas une nouvelle #}
                <input type="hidden" name="current_image" value="{{ data.image_une }}">
            </div>
        {% endif %}

		<div class="mb-3">
            <label class="form-label fw-bold">Tags associés :</label>
            <div class="card p-3" style="background-color: var(--bg2); border: 1px solid #ccc; max-height: 150px; overflow-y: auto;">
                {% if tousLesTags is empty %}
                    <small class="text-muted">Aucun tag disponible. Demandez à un administrateur d'en créer.</small>
                {% else %}
                    <div class="d-flex flex-wrap gap-3">
                        {% for tag in tousLesTags %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       name="tags[]" 
                                       value="{{ tag.id }}" 
                                       id="tag_{{ tag.id }}"
                                       {# Coché si on est en édition ET que l'ID est dans tagsActuels #}
                                       {% if is_edit and tag.id in tagsActuels %}checked{% endif %}>
                                <label class="form-check-label" for="tag_{{ tag.id }}">
                                    #{{ tag.nom_tag }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <label for="statut">Statut :</label>
        <select name="statut" id="statut" class="form-select mb-3" style="background-color: var(--bg2); color: var(--font-color); border: none; padding: 10px; border-radius: 4px;">
            <option value="Brouillon" {{ data.statut == 'Brouillon' ? 'selected' : '' }}>Brouillon</option>
            {% if peutPublier %}
                <option value="Publié" {{ data.statut == 'Publié' ? 'selected' : '' }}>Publié</option>
                <option value="Archivé" {{ data.statut == 'Archivé' ? 'selected' : '' }}>Archivé</option>
            {% endif %}
        </select>

        <label for="contenu">Contenu :</label>
        <textarea id="contenu" name="contenu">{{ data.contenu }}</textarea>

        <div class="d-flex gap-3 mt-3">
            <button type="submit" class="btn btn-primary">
                {{ is_edit ? "Mettre à jour" : "Enregistrer" }}
            </button>
            <a href="/connexion" class="btn btn-secondary text-decoration-none text-white d-flex align-items-center">
                Annuler
            </a>
        </div>
    </form>

    <script>
        const easyMDE = new EasyMDE({ 
            element: document.getElementById('contenu'),
            spellChecker: false,
            minHeight: "300px",
            promptURLs: true
        });
    </script>
{% endblock %}