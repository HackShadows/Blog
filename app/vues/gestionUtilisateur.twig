<div x-data="{modalOpen : false, userToEdit: null, userRoles: [], openModal(id, roles) {
        this.userToEdit = id;
        this.userRoles = roles;
        this.modalOpen = true;
    }}">
	<table>
		<thead>
		<tr>
			<th>
				ID
			</th>
			<th>
				Pseudo
			</th>
			<th>
				E-mail
			</th>
			<th>
				Date d'inscription
			</th>
			<th>
				Est Actif ?
			</th>
		</tr>
		</thead>
		{% for utilisateur in listeUtilisateurs %}
			<tr x-data="{ estActif: {{ utilisateur.est_actif }} }">
				<td>
					{{ utilisateur['id'] }}
				</td>
				<td>
					{{ utilisateur['nom_utilisateur'] }}
				</td>
				<td>
					{{ utilisateur['email'] }}
				</td>
				<td>
					{{ utilisateur['date_inscription'] }}
				</td>
				<td>
                        <span x-text="estActif ? 'Actif' : 'Inactif'"
							  :class="estActif ? 'badge bg-success' : 'badge bg-secondary'">
                        </span>
				</td>
				<td>
					<button type="button" class="btn btn-sm" :class="estActif ? 'btn-warning' : 'btn-success'"
							@click="let donnees = new FormData();
                                        donnees.append('id', {{ utilisateur.id }});
                                        fetch('changerUtilisateur', {method: 'POST', body: donnees});
                                        estActif = !estActif;"
							x-text="estActif ? 'Désactiver' : 'Activer'">
					</button>
				</td>
				<td>
					{% for role in utilisateur.roles %}
						<span class="badge bg-info text-dark">{{ role.nom_role }}</span>
					{% else %}
						<span class="badge bg-secondary">Aucun</span>
					{% endfor %}
				</td>
				<td>
					<button class="btn btn-primary btn-sm"
							@click.prevent.stop="openModal(
									{{ utilisateur.id }},
									[
										{% for r in utilisateur.roles %}
											{{ r.id }},
										{% endfor %}
									]
								)">
						Modifier Rôles
					</button>
				</td>
				<td>
					<form action="/supprimerUtilisateur" method="POST"
						  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer définitivement cet utilisateur ? Cette action est irréversible.');">

						<input type="hidden" name="user_id" value="{{ utilisateur.id }}">
						<button type="submit" class="btn btn-danger btn-sm">
							<i class="bi bi-trash"></i> Supprimer
						</button>
					</form>
				</td>
			</tr>
		{% endfor %}
	</table>

	{# --- MODALE 100% ALPINE (Sans Bootstrap JS) --- #}
	{# Fond gris (Overlay) #}
	<div x-show="modalOpen"
		 x-transition
		 style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">

		{# La boîte blanche (La modale) #}
		{# @click.away ferme la modale si on clique à côté #}
		<div @click.away="modalOpen = false"
			 style="background: white; padding: 2rem; border-radius: 8px; width: 500px; max-width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">

			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
				<h3 style="margin: 0;">Attribuer des rôles</h3>
				<button type="button" @click="modalOpen = false"
						style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;
				</button>
			</div>

			<form action="/majRoles" method="POST">
				{# ID de l'utilisateur injecté dynamiquement #}
				<input type="hidden" name="user_id" :value="userToEdit">

				<p>Cochez les rôles souhaités :</p>

				<div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
					{% for role in tousLesRoles %}
						<label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border: 1px solid #eee; border-radius: 4px;">
							<input type="checkbox"
								   name="roles[]"
								   value="{{ role.id }}"
								   :checked="userRoles.includes({{ role.id }})">
							<div>
								<strong>{{ role.nom_role }}</strong>
								<div style="font-size: 0.8em; color: gray;">{{ role.description }}</div>
							</div>
						</label>
					{% endfor %}
				</div>

				<div style="display: flex; justify-content: flex-end; gap: 10px;">
					<button type="button" class="btn btn-secondary" @click="modalOpen = false">Annuler</button>
					<button type="submit" class="btn btn-success">Enregistrer</button>
				</div>
			</form>
		</div>
	</div>
</div>