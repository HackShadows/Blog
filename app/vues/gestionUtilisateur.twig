<hr class="my-5">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Gestion des Utilisateurs</h2>
</div>

<div x-data="{
    modalOpen: false, 
    userToEdit: null, 
    userRoles: [], 
    openModal(id, roles) {
        this.userToEdit = id;
        this.userRoles = roles;
        this.modalOpen = true;
    }
}">

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Utilisateur</th>
                    <th>Date d'inscription</th>
                    <th>R√¥les</th>
                    <th class="text-center">Statut</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for utilisateur in listeUtilisateurs %}
                    <tr>
                        <td>{{ utilisateur.id }}</td>
                        <td>
                            <strong>{{ utilisateur.nom_utilisateur }}</strong><br>
                            <small class="text-muted">{{ utilisateur.email }}</small>
                        </td>
                        <td>{{ utilisateur.date_inscription|date("d/m/Y H:i") }}</td>
                        
                        <td>
                            {% for role in utilisateur.roles %}
                                <span class="badge bg-info text-dark border border-info-subtle">{{ role.nom_role }}</span>
                            {% else %}
                                <span class="badge bg-light text-dark border">Aucun r√¥le</span>
                            {% endfor %}
                        </td>

                        <td class="text-center">
                            {% if utilisateur.est_actif %}
                                <span class="badge bg-success">Actif</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactif</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                
                                {% set roleIds = [] %}
                                {% for r in utilisateur.roles %}
                                    {% set roleIds = roleIds|merge([r.id]) %}
                                {% endfor %}
                                
                                <button type="button" class="btn btn-primary btn-sm" 
                                        @click="openModal({{ utilisateur.id }}, {{ roleIds|json_encode }})"
                                        title="G√©rer les r√¥les">
                                    üé≠ R√¥les
                                </button>

                                <form action="/changerUtilisateur" method="POST">
                                    <input type="hidden" name="id" value="{{ utilisateur.id }}">
                                    {% if utilisateur.est_actif %}
                                        <button type="submit" class="btn btn-warning btn-sm" title="D√©sactiver le compte">
                                            ‚è∏Ô∏è
                                        </button>
                                    {% else %}
                                        <button type="submit" class="btn btn-success btn-sm" title="Activer le compte">
                                            ‚ñ∂Ô∏è
                                        </button>
                                    {% endif %}
                                </form>

                                <form action="/supprimerUtilisateur" method="POST" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer d√©finitivement cet utilisateur ?');">
                                    <input type="hidden" name="user_id" value="{{ utilisateur.id }}">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Supprimer l'utilisateur">
                                        üóëÔ∏è
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center p-4">Aucun utilisateur trouv√©.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal-overlay" x-show="modalOpen" x-transition x-cloak style="display: none;">
        <div class="modal-container" @click.away="modalOpen = false">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between align-items-center mb-3">
                    <h5 class="modal-title">Attribuer des r√¥les</h5>
                    <button type="button" class="btn-close" @click="modalOpen = false"></button>
                </div>

                <form action="/majRoles" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="user_id" :value="userToEdit">
                        <p class="mb-2">S√©lectionnez les r√¥les pour cet utilisateur :</p>

                        <div class="list-group">
                            {% for role in tousLesRoles %}
                                <label class="list-group-item d-flex gap-3 align-items-center">
                                    <input class="form-check-input flex-shrink-0" 
                                           type="checkbox" 
                                           name="roles[]" 
                                           value="{{ role.id }}" 
                                           :checked="userRoles.includes({{ role.id }})">
                                    <span>
                                        <strong>{{ role.nom_role }}</strong>
                                        <small class="d-block text-muted">{{ role.description }}</small>
                                    </span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer mt-4 text-end">
                        <button type="button" class="btn btn-secondary me-2" @click="modalOpen = false">Annuler</button>
                        <button type="submit" class="btn btn-success">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .modal-container {
        width: 100%;
        max-width: 500px;
        background: var(--bg2);
        color: var(--font-color);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        padding: 2px;
        background-color: #198754;
    }
    .modal-content {
        background: var(--bg2);
        padding: 20px;
        border-radius: 6px;
    }
    [x-cloak] { display: none !important; }
</style>